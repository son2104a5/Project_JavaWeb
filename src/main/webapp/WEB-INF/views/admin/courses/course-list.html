<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Course Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
          integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer"/>
</head>
<body class="bg-gray-100 text-sm text-gray-800">
<header th:replace="admin/fragments/header :: header"></header>
<div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside th:replace="admin/fragments/nav :: sidebar"></aside>

    <!-- Main content -->
    <main class="flex-1 p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">Course Manager</h2>
            <button onclick="openModal()" class="bg-blue-500 text-white px-12 py-2 rounded hover:bg-blue-600">
                Add new course
            </button>
        </div>

        <!-- Filters -->
        <div class="flex flex-wrap gap-4 mb-4 items-center justify-end">
            <select class="border rounded px-3 py-2">
                <option>Filter By Status</option>
            </select>
            <select class="border rounded px-3 py-2">
                <option>Sort By ID</option>
            </select>
            <div class="flex items-center border rounded px-2 py-1">
                <form th:action="@{/admin/courses}" method="get">
                    <input type="text" name="name" th:value="${name}" placeholder="Search course by name"
                           class="outline-none px-2 py-1 w-48">
                </form>
                <button class="ml-2 bg-blue-500 text-white px-3 py-1 rounded">Search</button>
            </div>
        </div>

        <!-- Course table -->
        <div class="bg-white rounded shadow">
            <table class="w-full text-left">
                <thead class="bg-gray-100">
                <tr class="border-b">
                    <th class="p-3 text-gray-500">Course ID</th>
                    <th class="p-3 text-gray-500">Course Name</th>
                    <th class="p-3 text-gray-500">Duration (Hour)</th>
                    <th class="p-3 text-gray-500">Instructor</th>
                    <th class="p-3 text-gray-500">Image</th>
                    <th class="p-3 text-gray-500">Created Date</th>
                    <th class="p-3 text-gray-500">Action</th>
                </tr>
                </thead>
                <tbody th:each="course : ${courses}">
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-medium" th:text="'C' + ${#numbers.formatInteger(course.id, 5)}"></td>
                    <td class="p-3 font-medium" th:text="${course.name}"></td>
                    <td class="p-3 font-medium" th:text="${course.duration}"></td>
                    <td class="p-3 font-medium" th:text="${course.instructor}"></td>
                    <td class="p-3 font-medium">
                        <img th:src="${course.image}" alt="course" class="w-10 h-10 object-cover rounded">
                    </td>
                    <td class="p-3 font-medium" th:text="${course.createdAt}"></td>
                    <td class="px-3 py-6 flex items-center gap-3">
                        <button class="text-red-500 hover:text-red-700"
                                th:onclick="'openDeleteModal(' + ${course.id} + ')'">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                        <button class="text-yellow-500 hover:text-yellow-600"
                                onclick="openEditModal(this)"
                                th:attr="data-id=${course.id},
                                     data-name=${course.name},
                                     data-image=${course.image},
                                     data-duration=${course.duration},
                                     data-instructor=${course.instructor}">
                            <i class="fa-solid fa-pen"></i>
                        </button>

                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="flex justify-center mt-6 gap-2" th:if="${totalPages > 1}">
            <a th:href="@{/courses(page=${currentPage - 1}, name=${name})}"
               class="px-2 py-1 border rounded hover:bg-gray-200"
               th:classappend="${currentPage == 1} ? 'pointer-events-none opacity-50' : ''">
                <
            </a>
            <span th:each="i : ${#numbers.sequence(1, totalPages)}">
                        <a th:href="@{/courses(page=${i}, name=${name})}"
                           th:text="${i}"
                           class="px-2 py-1 border rounded"
                           th:classappend="${i == currentPage} ? 'bg-blue-500 text-white' : 'hover:bg-gray-200'">
                        </a>
                    </span>
            <a th:href="@{/courses(page=${currentPage + 1}, name=${name})}"
               class="px-2 py-1 border rounded hover:bg-gray-200"
               th:classappend="${currentPage == totalPages} ? 'pointer-events-none opacity-50' : ''">
                >
            </a>
        </div>

        <!-- Add Course Modal -->
        <div id="addCourseModal"
             class="fixed inset-0 bg-black bg-opacity-30 z-50 hidden flex items-center justify-center">
            <div class="bg-white p-6 rounded shadow-md w-[450px]">
                <form th:action="@{${formAction}}" method="post" enctype="multipart/form-data" th:object="${course}">
                    <h2 class="text-lg font-semibold mb-4" th:text="${formTitle}"></h2>
                    <div style="height: 90px">
                        <label class="py-2" for="name">Course Name</label>
                        <input type="text" name="name" id="name" placeholder="Course Name" th:field="*{name}"
                               class="w-full px-4 py-2 border rounded outline-none"/>
                        <p th:if="${#fields.hasErrors('name')}" th:errors="*{name}"
                           class="text-red-500 text-sm mt-1"></p>
                    </div>
                    <div style="height: 90px">
                        <label class="py-2" for="duration">Duration (in hours)</label>
                        <input type="number" name="duration" id="duration" placeholder="Duration" th:field="*{duration}"
                               class="w-full px-4 py-2 border rounded outline-none"/>
                        <p th:if="${#fields.hasErrors('duration')}" th:errors="*{duration}"
                           class="text-red-500 text-sm mt-1"></p>
                    </div>
                    <div style="height: 90px">
                        <label class="py-2" for="instructor">Instructor</label>
                        <input type="text" name="instructor" id="instructor" placeholder="Instructor"
                               th:field="*{instructor}"
                               class="w-full px-4 py-2 border rounded outline-none"/>
                        <p th:if="${#fields.hasErrors('instructor')}" th:errors="*{instructor}"
                           class="text-red-500 text-sm mt-1"></p>
                    </div>
                    <div style="height: 90px">
                        <label class="py-2" for="imageFile">Course Image</label>
                        <input type="file" name="image" id="imageFile" class="w-full"/>
                        <img id="previewImage" src="" alt="Preview" width="50" height="50" class="mt-2 rounded hidden">
                    </div>
                    <div class="flex justify-center gap-3 mt-4">
                        <button type="button" onclick="closeModal()"
                                class="border border-gray-300 px-4 py-2 rounded hover:bg-gray-100">Cancel
                        </button>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                                th:text="${formButtonLabel}"></button>
                    </div>
                </form>
            </div>
        </div>
    </main>
</div>

<div id="deleteModal"
     class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center">
    <div class="bg-white p-6 rounded shadow-md w-[400px]">
        <div class="text-red-500 text-3xl mb-2">
            <i class="fa-solid fa-circle-exclamation"></i>
        </div>
        <h2 class="text-lg font-semibold">Xác nhận</h2>
        <p>Bạn có chắc chắn muốn xóa khóa học này không?</p>
        <div class="flex justify-end gap-3 mt-6">
            <button onclick="closeDeleteModal()" class="px-4 py-2 border rounded hover:bg-gray-100">Hủy</button>
            <form id="deleteForm" method="post" th:action="@{/admin/courses/delete/id}" th:object="${course}">
                <input type="hidden" name="id" id="deleteCourseId"/>
                <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Ok</button>
            </form>
        </div>
    </div>
</div>
</div>


<script th:inline="javascript">
    function openModal() {
        document.getElementById('addCourseModal').classList.remove('hidden');
        document.querySelector('#addCourseModal h2').innerText = 'Add new course';
        document.querySelector('#addCourseModal form').setAttribute('action', '/admin/courses/add');

        document.getElementById('name').value = '';
        document.getElementById('duration').value = 0;
        document.getElementById('instructor').value = '';
        const imagePreview = document.querySelector('#addCourseModal img');
        imagePreview.src = '';
        imagePreview.classList.add('hidden');
    }


    function closeModal() {
        document.getElementById('addCourseModal').classList.add('hidden');
        const imagePreview = document.querySelector('#addCourseModal img');
    }

    function openEditModal(btn) {
        document.getElementById('addCourseModal').classList.remove('hidden');

        // Đổ dữ liệu
        document.getElementById('name').value = btn.dataset.name;
        document.getElementById('duration').value = btn.dataset.duration;
        document.getElementById('instructor').value = btn.dataset.instructor;
        document.getElementById('courseId').value = btn.dataset.id;

        const imagePreview = document.querySelector('#addCourseModal img');
        if (btn.dataset.image) {
            imagePreview.src = btn.dataset.image;
            imagePreview.classList.remove('hidden');
        } else {
            imagePreview.src = '';
            imagePreview.classList.add('hidden');
        }

        // Cập nhật action + tiêu đề form
        document.querySelector('#addCourseModal h2').innerText = 'Update course';
        document.querySelector('#addCourseModal form').setAttribute('action', '/admin/courses/update/' + btn.dataset.id);
    }


    function openDeleteModal(id) {
        document.getElementById("deleteModal").classList.remove("hidden");
        document.getElementById("deleteCourseId").value = id;

        // Cập nhật action form xóa mềm
        const form = document.getElementById("deleteForm");
        form.setAttribute("action", `/admin/courses/delete/${id}`);
    }

    function closeDeleteModal() {
        document.getElementById("deleteModal").classList.add("hidden");
    }

    window.onload = function () {
        if ([[${hasErrors} ? true : false]]) {
            openModal();
        }
    };

</script>
</body>
</html>